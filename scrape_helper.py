import time
import subprocess
import requests
from config import *
import json


def rotate_ip(adb_device):
    print('Rotating IP...')
    adb_device.shell('cmd statusbar expand-settings')
    time.sleep(0.5)
    adb_device.shell("input tap {} {}".format(X_PLANE, Y_PLANE))
    time.sleep(5)
    adb_device.shell("input tap {} {}".format(X_PLANE, Y_PLANE))
    time.sleep(1)
    adb_device.shell("input tap {} {}".format(X_WIFI, Y_WIFI))
    time.sleep(0.5)
    adb_device.shell('input keyevent 3')
    time.sleep(3)

    connect_token = False
    while not connect_token:

        cmd = "netsh wlan connect name={0} ssid={0}".format(PHONE_SSID)
        k = subprocess.run(cmd, capture_output=True, text=True).stdout
        time.sleep(3)
        try:
            ip = requests.get('https://api.ipify.org').text
            print(f'IP address: {ip}')
            break
        except Exception:
            continue


def get_stats(stats_api_url):

    response = json.loads(requests.get(stats_api_url).text)
    stats = {
        'registrations': response['stats'][0]['totals']["Payout"],
        'hits': response['stats'][0]['totals']["Unique Hits"],
        'CTR': response['stats'][0]['totals']["Payout"] / response['stats'][0]['totals']["Unique Hits"]
    }
    return stats
