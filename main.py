from adb_shell.auth.sign_pythonrsa import PythonRSASigner
from adb_shell.adb_device import AdbDeviceUsb
import json
from user_faker import *
from anticaptcha import *
from scrape_helper import *
from webdriver import *

import time


adbkey = 'adbkey'
with open(adbkey) as f:
    priv = f.read()
with open(adbkey + '.pub') as f:
    pub = f.read()
signer = PythonRSASigner(pub, priv)

my_phone = AdbDeviceUsb()
my_phone.connect(rsa_keys=[signer], auth_timeout_s=0.1)

faker = UserFaker()
data_sets = faker.generate_data(1000)
users = data_sets

with open('usernames.txt', 'w', encoding='utf-8') as f:
    for data in data_sets:
        newMail = data['username'] + '@' + data['email'].split('@')[1]
        data['email'] = newMail
        f.write(json.dumps(data))
        f.write('\n')
i = 0
registrationsCount = int(input("Current number of registrations: "))
visitsCount = int(input("Current number of unique hits: "))

while i < len(users):

    web = Driver()
    web.log('info', '***********************')
    rotate_ip(my_phone)
    if i < 0:
        i = 0
    user = users[i]

    print("Working with user: i=" + str(i))
    print(user)

    URL_REGISTER = "https://fr.chaturbate.com/accounts/register/"
    AFFLIATE_URL = random.choice(["https://chaturbate.com/in/?track=default&tour=ZmU7&campaign=TOr2v",
                                  "http://live-amateur-cams.com",
                                  "http://live-xcams.com"])


    browser = web.get_browser()

    # Check CTR ratio
    CTR = registrationsCount / visitsCount
    if not 0.03 < CTR < random.uniform(0.07, 0.1):
        #CTR too high, visit mode enabled
        print("CTR = " + str(CTR) + "\n" + "CTR too high, entering visits mode")

        #keep-alive: connect to user account or stay anonymous
        with open("done.txt", "r") as f:
            accounts = f.read()
        if accounts is not None:
            if random.choice([True, False]):
                currentAccount = json.loads(random.choice(accounts.split("\n")))
                web.browse_url(AFFLIATE_URL)
                time.sleep(randint(2, 10))
                web.browse_url('https://fr.chaturbate.com/auth/login/')
                inputUsername = browser.find_element_by_xpath('//input[@name="username"]')
                inputUsername.send_keys(currentAccount['username'])
                inputPassword = browser.find_element_by_xpath('//input[@name="password"]')
                inputPassword.send_keys(currentAccount['password'])
                time.sleep(1)
                browser.find_element_by_xpath('//input[@type="submit"]').click()
                time.sleep(randint(1, 8))
                web.visit_rooms(browser, logged_in=True)
                web.close_browser()
                visitsCount += 1
                i += 1
                continue
            else:
                web.browse_url(AFFLIATE_URL)
                time.sleep(randint(5, 45))
                web.visit_rooms(browser, logged_in=False)
                web.close_browser()
                visitsCount += 1
                i += 1
                continue

        else:
            web.browse_url(AFFLIATE_URL)
            time.sleep(randint(5, 45))
            web.visit_rooms(browser, logged_in=False)
            web.close_browser()
            visitsCount += 1
            i += 1
            continue
    else:
        #Good CTR, registration mode enabled
        # Scraping in case of single user
        print("CTR = " + str(CTR) + "\n" + "Good CTR, entering registration mode")

        print("Opening affliate url")
        web.browse_url(AFFLIATE_URL)
        time.sleep(randint(2, 15))
        if check_exists_by_xpath(browser, '//a[text()="INSCRIPTION"]'):
            web.click_register(browser)
        else:
            web.close_browser()
            continue

        page_blocked_by_captcha = web.is_page_blocked_by_captcha()
        if page_blocked_by_captcha:
            print(web.is_page_blocked_by_captcha())
            print("Restarting the operation...")
            web.close_browser()
            continue

        ## Working with re-captcha
        captcha_site_key = web.get_site_captcha_key()
        if not captcha_site_key:
            web.close_browser()
            print("Unable to find google captcha key, switching proxy")
            web.log('error', 'Re-Captcha key not found, restarting wuth a  different proxy configuration')
            continue

        print("Auto-filling details")

        web.log('info', 'Registration under way...')
        web.log('info', 'Re-Captcha key: %s' % (captcha_site_key))
        print("Re-Captcha key")
        print(captcha_site_key)

        api = RecaptchaAPI(captcha_site_key)
        web.log('info', 'Re-Captcha auto-solve requested')

        if not web.is_jQuery_rendered_completely():
            print("Page not loaded completely, restarting the operation...")
            web.close_browser()
            continue

        web.form_input_text(browser, "input[name=\'username\']", user['username'], True)
        web.form_input_text(browser, "input[name=\'password\']", user['password'], True)
        #web.form_input_text(browser, "#id_email", user['email'], True)

        dob_set = user['dob'].split('-')
        web.form_select_option(browser, "select[name=\'birthday_month\']", dob_set[0])
        web.form_select_option(browser, "select[name=\'birthday_day\']", dob_set[1])
        web.form_select_option(browser, "select[name=\'birthday_year\']", dob_set[2])

        web.form_select_option(browser, "select[name=\'gender\']", user['gender'])

        web.form_select_checkbox(browser, 'id_terms')
        web.form_select_checkbox(browser, 'id_privacy_policy')

        web.log('info', 'Form filled with Username: %s, Password: %s, Email: %s, DOB: %s, Gender: %s' % (user['username'], user['password'], user['email'], dob_set, user['gender']))
        web.log('info', 'Requesting Re-captcha response')
        captcha_solved = api.get_response()
        web.log('info', ['Re-captcha response:', captcha_solved])
        web.form_input_text(browser, "textarea[id=\'g-recaptcha-response\']", captcha_solved['solution']['gRecaptchaResponse'], True)
        time.sleep(1)
        web.click_submit(browser)
        #web.execute_script(browser, "document.getElementsByTagName(\'form\')[1].submit();")
        web.log('info', 'Attempting registration')
        time.sleep(randint(3, 12))
        print("Registration successful")

        #visit rooms
        web.visit_rooms(browser, logged_in=True)

        time.sleep(randint(1, 10))
        web.log('info', 'Registration successful')
        web.log('info', '***********************')

        # saving user
        with open("done.txt", "a", encoding="utf-8") as f:
            f.write(json.dumps(user))
            f.write("\n")

        web.close_browser()
        print("Attempting registration...")
        i += 1
        registrationsCount += 1