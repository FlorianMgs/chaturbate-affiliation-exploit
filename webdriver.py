from selenium.common.exceptions import NoSuchElementException
from selenium.webdriver.common.keys import Keys
from bs4 import BeautifulSoup
import undetected_chromedriver.v2 as uc
from scrape_helper import *
import random
from random import randint

def check_exists_by_xpath(browser, xpath):
    try:
        browser.find_element_by_xpath(xpath)
    except NoSuchElementException:
        return False
    return True


class Driver:

    def get_browser(self):
        return self.browser

    def close_browser(self):
        self.browser.close()
        self.browser = None
        return True

    def init_browser(self):
        ## Initialize undetectable chrome browser
        browser = uc.Chrome()
        self.browser = browser
        browser.maximize_window()
        return browser

    def __init__(self, proxy=False):
        self.browser = self.init_browser()

    def is_page_blocked_by_captcha(self):
        try:
            self.browser.find_element_by_id("cf-error-details").find_element_by_xpath('/div/h1[@data-translate=\"challenge_headline\"]')
            return True
        except Exception as e:
            print(e)
            return False

    def is_jQuery_rendered_completely(self):
        try:
            self.execute_script(self.browser, "$ === jQuery")
        except:
            return False
        return True

    def browse_url(self, url):
        browser = self.browser
        print("Loading "+ str(url))
        repeat = False
        while not repeat:
            try:
                browser.get(url)
            except:
                return False
            time.sleep(0.09)
            repeat = True
        print("Page loaded successfully")
        return True

    def read_as_soup(self, browser):
        allHTML = BeautifulSoup(browser.page_source)
        html=allHTML.encode('utf-8')
        return BeautifulSoup(html, 'html.parser')

    def execute_script(self, browser, script):
        browser.execute_script(script)
        time.sleep(4)
        return True

    def get_site_captcha_key(self):
        try:
            return self.browser.find_element_by_xpath('//div[@class=\"g-recaptcha\"]').get_attribute('data-sitekey')
        except Exception as e:
            return False

    def open_url(self, browser, url):
        print("Loading "+ str(url))
        repeat = False
        while not repeat:
            try:
                browser.get(url)
                time.sleep(0.09)
                repeat = True
            except:
                print("Something went wrong loading the requested page, trying again!")
                repeat = False
                time.sleep(1)
        print("Page loaded successfully")
        return True

    def form_input_text(self, browser, selector, val, js=False, index=False):
        if not js:
            browser.find_element_by_id(selector).send_keys(Keys.CONTROL+"a")
            browser.find_element_by_id(selector).send_keys(Keys.BACKSPACE)
            browser.find_element_by_id(selector).send_keys(val)
        else:
            if not index:
                script = "jQuery(document).find(\""+ selector +"\").val(\'"+ val +"\');"
                script += "jQuery(document).find(\""+ selector +"\").trigger(\'change\');"
            else:
                script = "jQuery('"+ selector +"').eq(\'"+str(index)+"\').val('"+ val +"');"
                script += "jQuery('"+ selector +"').eq(\'"+str(index)+"\').trigger(\'change\');"
            time.sleep(0.09)
            browser.execute_script(script)
        time.sleep(0.09)
        return True

    """
    Selecting an option from the supplied select options parent
    jQuery(".bootstrap-select.beds").find('li a span:contains(1.0)').parent().trigger("click")
    """
    def form_select_option(self, browser, jQuerySelector, val_to_select):
        script = "jQuery(\"%s\").val(\'%s\');" % (jQuerySelector, val_to_select)
        script += "jQuery(\""+ jQuerySelector +"\").trigger(\'change\');"
        time.sleep(0.09)
        browser.execute_script(script)
        time.sleep(0.09)
        return True

    """
    Select checkbox
    jQuery("#hideContact").prop('checked', true)
    """
    def form_select_checkbox(self, browser, selector, js=False, index=False):
        if not js:
            time.sleep(0.09)
            browser.find_element_by_id(selector).click()
            time.sleep(0.09)
            return True
        if not index:
            script = "jQuery(document).find(\""+ selector +"\").prop('checked', true);"
            script += "jQuery(document).find(\""+ selector +"\").trigger(\'change\');"
        else:
            script = "jQuery('"+ selector +"').eq(\'"+str(index)+"\').prop('checked', true);"
            script += "jQuery('"+ selector +"').eq(\'"+str(index)+"\').trigger(\'change\');"
        time.sleep(0.09)
        browser.execute_script(script)
        return True



    def click_submit(self, browser):
        browser.find_element_by_id('formsubmit').click()
        return True

    def click_register(self, browser):
        browser.find_element_by_xpath('//a[text()="INSCRIPTION"]').click()
        return True

    def visit_rooms(self, browser, logged_in=False):
        if browser.current_url != 'https://fr.chaturbate.com/':
            browser.get('https://fr.chaturbate.com/')
            time.sleep(1)
        nb_rooms_to_check = randint(1, 8)
        i = 0
        while i < nb_rooms_to_check:
            rooms = browser.find_elements_by_class_name('room_list_room')
            room = random.choice(rooms)
            room.click()
            time.sleep(randint(5, 60))
            if logged_in:
                if random.choice([False, True]):
                    if check_exists_by_xpath(browser, '//div[@class="followButton gradient"]'):
                        browser.find_element_by_xpath('//div[@class="followButton gradient"]').click()

            time.sleep(randint(1, 15))
            browser.get('https://fr.chaturbate.com/')
            time.sleep(randint(2, 10))
            i += 1

        return True

    def login(self, browser, account):

        self.browse_url('https://fr.chaturbate.com/auth/login/')
        inputUsername = browser.find_element_by_xpath('//input[@name="username"]')
        inputUsername.send_keys(account['username'])
        inputPassword = browser.find_element_by_xpath('//input[@name="password"]')
        inputPassword.send_keys(account['password'])
        time.sleep(1)
        browser.find_element_by_xpath('//input[@type="submit"]').click()

        return True
